<!doctype html><html lang=en dir=auto>
<head><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=robots content="index, follow">
<title>WireGuard VPS as Reverse Proxy and Gateway to Home Network | Andrew's Admin Archives</title>
<meta name=keywords content="Homelab,WireGuard,VPS,Reverse Proxy,Networking">
<meta name=description content="Navigate around Carrier-Grade NAT (CGNAT) limitations by securely exposing your homelab services with a reverse proxy. Additionally, access your home network from anywhere using WireGuard. This setup requires only an affordable VPS hosting a public IP, coupled with a WireGuard connection established within your home network.">
<meta name=author content="Andrew">
<link rel=canonical href=https://adminarchives.com/posts/vps-wireguard-gateway/>
<link crossorigin=anonymous href=/assets/css/stylesheet.5cfc680b1eeaeef9efbced92d46c2a9e876b72ee14fba85846afc4cff9e6e6f8.css integrity="sha256-XPxoCx7q7vnvvO2S1Gwqnodrcu4U+6hYRq/Ez/nm5vg=" rel="preload stylesheet" as=style>
<script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://adminarchives.com/favicon.ico>
<link rel=icon type=image/png sizes=16x16 href=https://adminarchives.com/favicon-16x16.png>
<link rel=icon type=image/png sizes=32x32 href=https://adminarchives.com/favicon-32x32.png>
<link rel=apple-touch-icon href=https://adminarchives.com/apple-touch-icon.png>
<link rel=mask-icon href=https://adminarchives.com/safari-pinned-tab.svg>
<meta name=theme-color content="#2e2e33">
<meta name=msapplication-TileColor content="#2e2e33">
<noscript>
<style>#theme-toggle,.top-link{display:none}</style>
</noscript><meta property="og:title" content="WireGuard VPS as Reverse Proxy and Gateway to Home Network">
<meta property="og:description" content="Navigate around Carrier-Grade NAT (CGNAT) limitations by securely exposing your homelab services with a reverse proxy. Additionally, access your home network from anywhere using WireGuard. This setup requires only an affordable VPS hosting a public IP, coupled with a WireGuard connection established within your home network.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://adminarchives.com/posts/vps-wireguard-gateway/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2023-08-23T12:20:06-04:00">
<meta property="article:modified_time" content="2023-08-23T12:20:06-04:00"><meta property="og:site_name" content="Andrew's Admin Archives">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="WireGuard VPS as Reverse Proxy and Gateway to Home Network">
<meta name=twitter:description content="Navigate around Carrier-Grade NAT (CGNAT) limitations by securely exposing your homelab services with a reverse proxy. Additionally, access your home network from anywhere using WireGuard. This setup requires only an affordable VPS hosting a public IP, coupled with a WireGuard connection established within your home network.">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://adminarchives.com/posts/"},{"@type":"ListItem","position":2,"name":"WireGuard VPS as Reverse Proxy and Gateway to Home Network","item":"https://adminarchives.com/posts/vps-wireguard-gateway/"}]}</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"WireGuard VPS as Reverse Proxy and Gateway to Home Network","name":"WireGuard VPS as Reverse Proxy and Gateway to Home Network","description":"Navigate around Carrier-Grade NAT (CGNAT) limitations by securely exposing your homelab services with a reverse proxy. Additionally, access your home network from anywhere using WireGuard. This setup requires only an affordable VPS hosting a public IP, coupled with a WireGuard connection established within your home network.","keywords":["Homelab","WireGuard","VPS","Reverse Proxy","Networking"],"articleBody":"Why use this over services like Tailscale, Zerotier, etc? WireGuard through a VPS will give you\n More control over your network and where your data goes. Infrastructure independence; you will not need to rely on proprietary servers that could go down at any time. Host on VPS of your choosing and get a public IP for your homelab.  Also, it’s extremely fast. It can easily transfer over 500 mbit/s while only adding a few milliseconds of latency. This website is currently running through the setup and I am able to establish a connection through the VPS (hosted about 100 miles away) and back to my home network with less than 20ms of latency. I even host game servers with this setup and have friends connect from across the country without issue.\nNetwork Diagram +-------------+ | Internet | +-------------+ | | +------------+ +------------+ | Public | | Public | | Users || VPS | +------------+ +------------+ | | | | | | Public Reverse Proxy +-------------+ | | (for specific, forwarded services) | CGNAT | | +-------------+ | Secure WireGuard Network | | (Access entire home network | | if connected through WireGuard) +------------+ | | Home |Requirments  Device or VM on home network with Wireguard VPS with public IP, Wireguard, and a reverse proxy of choice.\n(Nginx Proxy Manager is great for most basic uses)  WireGuard Configs VPS Gateway First, we have the WireGuard config for the VPS. The config has IP rules that route any traffic coming in from the WireGuard interface to go back out of the WireGuard interface. This is what allows you to connect to the rest of your home network, as well as the internet through your home network. It also adds an optional route to your home network. This route is for the VPS itself to route to your home network through WireGuard, and should be used for if you have a public reverse proxy forwarding from your home network. Finally, it has your home WireGuard server as a peer, along with any other devices you’d like on the network.\nYour VPS may or may not have a firewall setup by default, but I recommend using UFW and only allowing connections on the ports for WireGuard and your reverse proxy.\n[Interface] # Use unique WG subnet Address = 10.0.0.1/24 ListenPort = 51820 PrivateKey = #### # Route incoming WG traffic out of WG interface (Forward to home WG server) Table = 123 PreUp = sysctl -w net.ipv4.ip_forward=1 PreUp = ip rule add iif wg0 table 123 priority 456 PostDown = ip rule del iif wg0 table 123 priority 456 PreUp = sysctl -w net.ipv6.conf.all.forwarding=1 PreUp = ip -6 rule add iif wg0 table 123 priority 456 PostDown = ip -6 rule del iif wg0 table 123 priority 456 # Make this your home subnet. Custom route for traffic from VPS/reverse proxy PostUp = ip route add 192.168.1.1/24 dev wg0 # Home WG server. Use keep alive behind NAT. [Peer] PublicKey = #### PresharedKey = #### AllowedIPs = 0.0.0.0/0 PersistentKeepalive = 25 # Add other clients here # Example: laptop client [Peer] PublicKey = #### PresharedKey = #### # Unique IP with /32 subnet (will only route packets for that ip to that device) AllowedIPs = 10.0.0.5/32 PersistentKeepalive = 25  NOTE: The Wireguard network and your home network must be on different subnets! Custom routing and masquarading rules will allow you to connect to home network through Wireguard. These rules were adapted from adapted from Multi Hop Wireguard by Justin Ludwig.\n Home Server Your home WireGuard server takes all traffic coming in and marks it with a tag. Packets with this tag are then masqueraded out through your servers default gateway (your home network or home router). This allows you to connect to other devices on the home network as well as the internet through your home network, such that any devices connected through WireGuard will share the same public IP as your home network.\n[Interface] PrivateKey = #### Address = 10.0.0.2/24 # Masquerade traffic over default network (Home lan/wan) PreUp = sysctl -w net.ipv4.ip_forward=1 PreUp = iptables -t mangle -A PREROUTING -i wg0 -j MARK --set-mark 0x30 PreUp = iptables -t nat -A POSTROUTING ! -o wg0 -m mark --mark 0x30 -j MASQUERADE PostDown = iptables -t mangle -D PREROUTING -i wg0 -j MARK --set-mark 0x30 PostDown = iptables -t nat -D POSTROUTING ! -o wg0 -m mark --mark 0x30 -j MASQUERADE PreUp = sysctl -w net.ipv6.conf.all.forwarding=1 PreUp = ip6tables -t mangle -A PREROUTING -i wg0 -j MARK --set-mark 0x30 PreUp = ip6tables -t nat -A POSTROUTING ! -o wg0 -m mark --mark 0x30 -j MASQUERADE PostDown = ip6tables -t mangle -D PREROUTING -i wg0 -j MARK --set-mark 0x30 PostDown = ip6tables -t nat -D POSTROUTING ! -o wg0 -m mark --mark 0x30 -j MASQUERADE # Public VPS gateway [Peer] PublicKey = #### PresharedKey = #### Endpoint = ##.##.##.##:51820 AllowedIPs = 10.0.0.1/24 PersistentKeepalive = 25 Nginx Reverse Proxy Finally, you may want to set up a reverse proxy. This will allow you to connect to services at home through a public domain as well as forward port streams directly, such as for a game server.\nI would highly recommend using Nginx Proxy Manager (NPM). Use the following Docker Compose to get it running very quick.\nversion: '3.8' services: nginx: image: 'jc21/nginx-proxy-manager:latest' container_name: proxy restart: unless-stopped network_mode: \"host\" volumes: - ./data:/data - ./letsencrypt:/etc/letsencrypt - /var/log/nginx:/var/log/nginx From the NPM web interface you can add domains and requests to those domain are forwarded to the specified IP address and port of a service on your home network. Now just point that domain towards your public VPS and you can connect to that domain from anywhere!\n","wordCount":"966","inLanguage":"en","datePublished":"2023-08-23T12:20:06-04:00","dateModified":"2023-08-23T12:20:06-04:00","author":{"@type":"Person","name":"Andrew"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://adminarchives.com/posts/vps-wireguard-gateway/"},"publisher":{"@type":"Organization","name":"Andrew's Admin Archives","logo":{"@type":"ImageObject","url":"https://adminarchives.com/favicon.ico"}}}</script>
</head>
<body class=dark id=top>
<script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove('dark')</script>
<header class=header>
<nav class=nav>
<div class=logo>
<a href=https://adminarchives.com/ accesskey=h title="Andrew's Admin Archives (Alt + H)">Andrew's Admin Archives</a>
<div class=logo-switches>
<button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</button>
</div>
</div>
<ul id=menu>
<li>
<a href=https://adminarchives.com/posts/ title=posts>
<span>posts</span>
</a>
</li>
<li>
<a href=https://adminarchives.com/tags/ title=tags>
<span>tags</span>
</a>
</li>
<li>
<a href=https://adminarchives.com/search/ title="search (Alt + /)" accesskey=/>
<span>search</span>
</a>
</li>
</ul>
</nav>
</header>
<main class=main>
<article class=post-single>
<header class=post-header>
<div class=breadcrumbs><a href=https://adminarchives.com/>Home</a>&nbsp;»&nbsp;<a href=https://adminarchives.com/posts/>Posts</a></div>
<h1 class=post-title>
WireGuard VPS as Reverse Proxy and Gateway to Home Network
</h1>
<div class=post-description>
Navigate around Carrier-Grade NAT (CGNAT) limitations by securely exposing your homelab services with a reverse proxy. Additionally, access your home network from anywhere using WireGuard. This setup requires only an affordable VPS hosting a public IP, coupled with a WireGuard connection established within your home network.
</div>
<div class=post-meta><span title="2023-08-23 12:20:06 -0400 EDT">August 23, 2023</span>&nbsp;·&nbsp;5 min&nbsp;·&nbsp;966 words&nbsp;·&nbsp;Andrew
</div>
</header> <div class=toc>
<details>
<summary accesskey=c title="(Alt + C)">
<span class=details>Table of Contents</span>
</summary>
<div class=inner><nav id=TableOfContents>
<ul>
<li><a href=#why-use-this-over-services-like-tailscale-zerotier-etc>Why use this over services like Tailscale, Zerotier, etc?</a></li>
<li><a href=#network-diagram>Network Diagram</a></li>
<li><a href=#requirments>Requirments</a></li>
<li><a href=#wireguard-configs>WireGuard Configs</a>
<ul>
<li><a href=#vps-gateway>VPS Gateway</a></li>
<li><a href=#home-server>Home Server</a></li>
</ul>
</li>
<li><a href=#nginx-reverse-proxy>Nginx Reverse Proxy</a></li>
</ul>
</nav>
</div>
</details>
</div>
<div class=post-content><h2 id=why-use-this-over-services-like-tailscale-zerotier-etc>Why use this over services like Tailscale, Zerotier, etc?<a hidden class=anchor aria-hidden=true href=#why-use-this-over-services-like-tailscale-zerotier-etc>#</a></h2>
<p>WireGuard through a VPS will give you</p>
<ul>
<li>More control over your network and where your data goes.</li>
<li>Infrastructure independence; you will not need to rely on proprietary servers that could go down at any time.</li>
<li>Host on VPS of your choosing and get a public IP for your homelab.</li>
</ul>
<p>Also, it&rsquo;s <em>extremely</em> fast. It can easily transfer over 500 mbit/s while only adding a few milliseconds of latency.
This website is currently running through the setup and I am able to establish a connection through the VPS (hosted about 100 miles away) and back to my home network with less than 20ms of latency. I even host game servers with this setup and have friends connect from across the country without issue.</p>
<h2 id=network-diagram>Network Diagram<a hidden class=anchor aria-hidden=true href=#network-diagram>#</a></h2>
<pre tabindex=0><code class=language-less data-lang=less>   +-------------+
   |  Internet   |
   +-------------+
        |
        |
   +------------+      +------------+
   |   Public   |      |  Public    |
   |    Users   |&lt;----&gt;|    VPS     |  
   +------------+      +------------+
                          |      |
                          |      | 
                          |      | Public Reverse Proxy 
   +-------------+        |      | (for specific, forwarded services)
   |   CGNAT     |        |      
   +-------------+        | Secure WireGuard Network
        |                 | (Access entire home network
        |                 | if connected through WireGuard)
   +------------+         | 
   |   Home     |&lt;--------+
   | WireGuard  |
   |  Server    |
   +------------+
        |
   +-------------+
   | Home Network|
   | &amp; Services  |
   +-------------+
</code></pre><h2 id=requirments>Requirments<a hidden class=anchor aria-hidden=true href=#requirments>#</a></h2>
<ul>
<li>Device or VM on home network with Wireguard</li>
<li>VPS with public IP, Wireguard, and a reverse proxy of choice.<br>
(Nginx Proxy Manager is great for most basic uses)</li>
</ul>
<h2 id=wireguard-configs>WireGuard Configs<a hidden class=anchor aria-hidden=true href=#wireguard-configs>#</a></h2>
<h3 id=vps-gateway>VPS Gateway<a hidden class=anchor aria-hidden=true href=#vps-gateway>#</a></h3>
<p>First, we have the WireGuard config for the VPS. The config has IP rules that route any traffic coming in from the WireGuard interface to go back out of the WireGuard interface. This is what allows you to connect to the rest of your home network, as well as the internet through your home network. It also adds an optional route to your home network. This route is for the VPS itself to route to your home network through WireGuard, and should be used for if you have a public reverse proxy forwarding from your home network. Finally, it has your home WireGuard server as a peer, along with any other devices you&rsquo;d like on the network.</p>
<p>Your VPS may or may not have a firewall setup by default, but I recommend using UFW and only allowing connections on the ports for WireGuard and your reverse proxy.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml>[<span style=color:#a6e22e>Interface</span>]
<span style=color:#75715e># Use unique WG subnet</span>
<span style=color:#a6e22e>Address</span> = <span style=color:#ae81ff>10.0</span>.<span style=color:#ae81ff>0.1</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#ae81ff>24</span>  
<span style=color:#a6e22e>ListenPort</span> = <span style=color:#ae81ff>51820</span>
<span style=color:#a6e22e>PrivateKey</span> = <span style=color:#75715e>####</span>


<span style=color:#75715e># Route incoming WG traffic out of WG interface (Forward to home WG server)</span>
<span style=color:#a6e22e>Table</span> = <span style=color:#ae81ff>123</span>
<span style=color:#a6e22e>PreUp</span> = <span style=color:#a6e22e>sysctl</span> <span style=color:#a6e22e>-w</span> <span style=color:#a6e22e>net</span>.<span style=color:#a6e22e>ipv4</span>.<span style=color:#a6e22e>ip_forward</span>=<span style=color:#ae81ff>1</span>
<span style=color:#a6e22e>PreUp</span> = <span style=color:#a6e22e>ip</span> <span style=color:#a6e22e>rule</span> <span style=color:#a6e22e>add</span> <span style=color:#a6e22e>iif</span> <span style=color:#a6e22e>wg0</span> <span style=color:#a6e22e>table</span> <span style=color:#ae81ff>123</span> <span style=color:#a6e22e>priority</span> <span style=color:#ae81ff>456</span>
<span style=color:#a6e22e>PostDown</span> = <span style=color:#a6e22e>ip</span> <span style=color:#a6e22e>rule</span> <span style=color:#a6e22e>del</span> <span style=color:#a6e22e>iif</span> <span style=color:#a6e22e>wg0</span> <span style=color:#a6e22e>table</span> <span style=color:#ae81ff>123</span> <span style=color:#a6e22e>priority</span> <span style=color:#ae81ff>456</span>

<span style=color:#a6e22e>PreUp</span> = <span style=color:#a6e22e>sysctl</span> <span style=color:#a6e22e>-w</span> <span style=color:#a6e22e>net</span>.<span style=color:#a6e22e>ipv6</span>.<span style=color:#a6e22e>conf</span>.<span style=color:#a6e22e>all</span>.<span style=color:#a6e22e>forwarding</span>=<span style=color:#ae81ff>1</span>
<span style=color:#a6e22e>PreUp</span> = <span style=color:#a6e22e>ip</span> <span style=color:#ae81ff>-6</span> <span style=color:#a6e22e>rule</span> <span style=color:#a6e22e>add</span> <span style=color:#a6e22e>iif</span> <span style=color:#a6e22e>wg0</span> <span style=color:#a6e22e>table</span> <span style=color:#ae81ff>123</span> <span style=color:#a6e22e>priority</span> <span style=color:#ae81ff>456</span>
<span style=color:#a6e22e>PostDown</span> = <span style=color:#a6e22e>ip</span> <span style=color:#ae81ff>-6</span> <span style=color:#a6e22e>rule</span> <span style=color:#a6e22e>del</span> <span style=color:#a6e22e>iif</span> <span style=color:#a6e22e>wg0</span> <span style=color:#a6e22e>table</span> <span style=color:#ae81ff>123</span> <span style=color:#a6e22e>priority</span> <span style=color:#ae81ff>456</span>

<span style=color:#75715e># Make this your home subnet. Custom route for traffic from VPS/reverse proxy</span>

<span style=color:#a6e22e>PostUp</span> = <span style=color:#a6e22e>ip</span> <span style=color:#a6e22e>route</span> <span style=color:#a6e22e>add</span> <span style=color:#ae81ff>192.168</span>.<span style=color:#ae81ff>1.1</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#ae81ff>24</span> <span style=color:#a6e22e>dev</span> <span style=color:#a6e22e>wg0</span>

<span style=color:#75715e># Home WG server. Use keep alive behind NAT.</span>
[<span style=color:#a6e22e>Peer</span>]
<span style=color:#a6e22e>PublicKey</span> = <span style=color:#75715e>####</span>
<span style=color:#a6e22e>PresharedKey</span> = <span style=color:#75715e>####</span>
<span style=color:#a6e22e>AllowedIPs</span> = <span style=color:#ae81ff>0.0</span>.<span style=color:#ae81ff>0.0</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#ae81ff>0</span>
<span style=color:#a6e22e>PersistentKeepalive</span> = <span style=color:#ae81ff>25</span>

<span style=color:#75715e># Add other clients here</span>

<span style=color:#75715e># Example: laptop client</span>
[<span style=color:#a6e22e>Peer</span>]
<span style=color:#a6e22e>PublicKey</span> = <span style=color:#75715e>####</span>
<span style=color:#a6e22e>PresharedKey</span> = <span style=color:#75715e>####</span>
<span style=color:#75715e># Unique IP with /32 subnet (will only route packets for that ip to that device)</span>
<span style=color:#a6e22e>AllowedIPs</span> = <span style=color:#ae81ff>10.0</span>.<span style=color:#ae81ff>0.5</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#ae81ff>32</span> 
<span style=color:#a6e22e>PersistentKeepalive</span> = <span style=color:#ae81ff>25</span>

</code></pre></div><blockquote>
<p><strong>NOTE: The Wireguard network and your home network must be on different subnets!</strong> Custom routing and masquarading rules will allow you to connect to home network through Wireguard. These rules were adapted from adapted from <a href=https://www.procustodibus.com/blog/2022/06/multi-hop-wireguard/>Multi Hop Wireguard</a> by <a href=https://www.procustodibus.com/authors/justin-ludwig/>Justin Ludwig</a>.</p>
</blockquote>
<h3 id=home-server>Home Server<a hidden class=anchor aria-hidden=true href=#home-server>#</a></h3>
<p>Your home WireGuard server takes all traffic coming in and marks it with a tag. Packets with this tag are then masqueraded out through your servers default gateway (your home network or home router). This allows you to connect to other devices on the home network as well as the internet through your home network, such that any devices connected through WireGuard will share the same public IP as your home network.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml>[<span style=color:#a6e22e>Interface</span>]
<span style=color:#a6e22e>PrivateKey</span> = <span style=color:#75715e>####</span>
<span style=color:#a6e22e>Address</span> = <span style=color:#ae81ff>10.0</span>.<span style=color:#ae81ff>0.2</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#ae81ff>24</span>

<span style=color:#75715e># Masquerade traffic over default network (Home lan/wan)</span>
<span style=color:#a6e22e>PreUp</span> = <span style=color:#a6e22e>sysctl</span> <span style=color:#a6e22e>-w</span> <span style=color:#a6e22e>net</span>.<span style=color:#a6e22e>ipv4</span>.<span style=color:#a6e22e>ip_forward</span>=<span style=color:#ae81ff>1</span>
<span style=color:#a6e22e>PreUp</span> = <span style=color:#a6e22e>iptables</span> <span style=color:#a6e22e>-t</span> <span style=color:#a6e22e>mangle</span> <span style=color:#a6e22e>-A</span> <span style=color:#a6e22e>PREROUTING</span> <span style=color:#a6e22e>-i</span> <span style=color:#a6e22e>wg0</span> <span style=color:#a6e22e>-j</span> <span style=color:#a6e22e>MARK</span> <span style=color:#a6e22e>--set-mark</span> <span style=color:#ae81ff>0</span><span style=color:#a6e22e>x30</span>
<span style=color:#a6e22e>PreUp</span> = <span style=color:#a6e22e>iptables</span> <span style=color:#a6e22e>-t</span> <span style=color:#a6e22e>nat</span> <span style=color:#a6e22e>-A</span> <span style=color:#a6e22e>POSTROUTING</span> <span style=color:#960050;background-color:#1e0010>!</span> <span style=color:#a6e22e>-o</span> <span style=color:#a6e22e>wg0</span> <span style=color:#a6e22e>-m</span> <span style=color:#a6e22e>mark</span> <span style=color:#a6e22e>--mark</span> <span style=color:#ae81ff>0</span><span style=color:#a6e22e>x30</span> <span style=color:#a6e22e>-j</span> <span style=color:#a6e22e>MASQUERADE</span>
<span style=color:#a6e22e>PostDown</span> = <span style=color:#a6e22e>iptables</span> <span style=color:#a6e22e>-t</span> <span style=color:#a6e22e>mangle</span> <span style=color:#a6e22e>-D</span> <span style=color:#a6e22e>PREROUTING</span> <span style=color:#a6e22e>-i</span> <span style=color:#a6e22e>wg0</span> <span style=color:#a6e22e>-j</span> <span style=color:#a6e22e>MARK</span> <span style=color:#a6e22e>--set-mark</span> <span style=color:#ae81ff>0</span><span style=color:#a6e22e>x30</span>
<span style=color:#a6e22e>PostDown</span> = <span style=color:#a6e22e>iptables</span> <span style=color:#a6e22e>-t</span> <span style=color:#a6e22e>nat</span> <span style=color:#a6e22e>-D</span> <span style=color:#a6e22e>POSTROUTING</span> <span style=color:#960050;background-color:#1e0010>!</span> <span style=color:#a6e22e>-o</span> <span style=color:#a6e22e>wg0</span> <span style=color:#a6e22e>-m</span> <span style=color:#a6e22e>mark</span> <span style=color:#a6e22e>--mark</span> <span style=color:#ae81ff>0</span><span style=color:#a6e22e>x30</span> <span style=color:#a6e22e>-j</span> <span style=color:#a6e22e>MASQUERADE</span>

<span style=color:#a6e22e>PreUp</span> = <span style=color:#a6e22e>sysctl</span> <span style=color:#a6e22e>-w</span> <span style=color:#a6e22e>net</span>.<span style=color:#a6e22e>ipv6</span>.<span style=color:#a6e22e>conf</span>.<span style=color:#a6e22e>all</span>.<span style=color:#a6e22e>forwarding</span>=<span style=color:#ae81ff>1</span>
<span style=color:#a6e22e>PreUp</span> = <span style=color:#a6e22e>ip6tables</span> <span style=color:#a6e22e>-t</span> <span style=color:#a6e22e>mangle</span> <span style=color:#a6e22e>-A</span> <span style=color:#a6e22e>PREROUTING</span> <span style=color:#a6e22e>-i</span> <span style=color:#a6e22e>wg0</span> <span style=color:#a6e22e>-j</span> <span style=color:#a6e22e>MARK</span> <span style=color:#a6e22e>--set-mark</span> <span style=color:#ae81ff>0</span><span style=color:#a6e22e>x30</span>
<span style=color:#a6e22e>PreUp</span> = <span style=color:#a6e22e>ip6tables</span> <span style=color:#a6e22e>-t</span> <span style=color:#a6e22e>nat</span> <span style=color:#a6e22e>-A</span> <span style=color:#a6e22e>POSTROUTING</span> <span style=color:#960050;background-color:#1e0010>!</span> <span style=color:#a6e22e>-o</span> <span style=color:#a6e22e>wg0</span> <span style=color:#a6e22e>-m</span> <span style=color:#a6e22e>mark</span> <span style=color:#a6e22e>--mark</span> <span style=color:#ae81ff>0</span><span style=color:#a6e22e>x30</span> <span style=color:#a6e22e>-j</span> <span style=color:#a6e22e>MASQUERADE</span>
<span style=color:#a6e22e>PostDown</span> = <span style=color:#a6e22e>ip6tables</span> <span style=color:#a6e22e>-t</span> <span style=color:#a6e22e>mangle</span> <span style=color:#a6e22e>-D</span> <span style=color:#a6e22e>PREROUTING</span> <span style=color:#a6e22e>-i</span> <span style=color:#a6e22e>wg0</span> <span style=color:#a6e22e>-j</span> <span style=color:#a6e22e>MARK</span> <span style=color:#a6e22e>--set-mark</span> <span style=color:#ae81ff>0</span><span style=color:#a6e22e>x30</span>
<span style=color:#a6e22e>PostDown</span> = <span style=color:#a6e22e>ip6tables</span> <span style=color:#a6e22e>-t</span> <span style=color:#a6e22e>nat</span> <span style=color:#a6e22e>-D</span> <span style=color:#a6e22e>POSTROUTING</span> <span style=color:#960050;background-color:#1e0010>!</span> <span style=color:#a6e22e>-o</span> <span style=color:#a6e22e>wg0</span> <span style=color:#a6e22e>-m</span> <span style=color:#a6e22e>mark</span> <span style=color:#a6e22e>--mark</span> <span style=color:#ae81ff>0</span><span style=color:#a6e22e>x30</span> <span style=color:#a6e22e>-j</span> <span style=color:#a6e22e>MASQUERADE</span>

<span style=color:#75715e># Public VPS gateway</span>
[<span style=color:#a6e22e>Peer</span>]
<span style=color:#a6e22e>PublicKey</span> = <span style=color:#75715e>####</span>
<span style=color:#a6e22e>PresharedKey</span> = <span style=color:#75715e>####</span>
<span style=color:#a6e22e>Endpoint</span> = <span style=color:#75715e>##.##.##.##:51820</span>
<span style=color:#a6e22e>AllowedIPs</span> = <span style=color:#ae81ff>10.0</span>.<span style=color:#ae81ff>0.1</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#ae81ff>24</span>
<span style=color:#a6e22e>PersistentKeepalive</span> = <span style=color:#ae81ff>25</span>
</code></pre></div><h2 id=nginx-reverse-proxy>Nginx Reverse Proxy<a hidden class=anchor aria-hidden=true href=#nginx-reverse-proxy>#</a></h2>
<p>Finally, you may want to set up a reverse proxy. This will allow you to connect to services at home through a public domain as well as forward port streams directly, such as for a game server.</p>
<p>I would highly recommend using Nginx Proxy Manager (NPM). Use the following Docker Compose to get it running very quick.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>version</span>: <span style=color:#e6db74>&#39;3.8&#39;</span>
<span style=color:#f92672>services</span>:
  <span style=color:#f92672>nginx</span>:
    <span style=color:#f92672>image</span>: <span style=color:#e6db74>&#39;jc21/nginx-proxy-manager:latest&#39;</span>
    <span style=color:#f92672>container_name</span>: <span style=color:#ae81ff>proxy</span>
    <span style=color:#f92672>restart</span>: <span style=color:#ae81ff>unless-stopped</span>
    <span style=color:#f92672>network_mode</span>: <span style=color:#e6db74>&#34;host&#34;</span>
    <span style=color:#f92672>volumes</span>:
      - <span style=color:#ae81ff>./data:/data</span>
      - <span style=color:#ae81ff>./letsencrypt:/etc/letsencrypt</span>
      - <span style=color:#ae81ff>/var/log/nginx:/var/log/nginx</span>
</code></pre></div><p>From the NPM web interface you can add domains and requests to those domain are forwarded to the specified IP address and port of a service on your home network. Now just point that domain towards your public VPS and you can connect to that domain from anywhere!</p>
</div>
<footer class=post-footer>
<ul class=post-tags>
<li><a href=https://adminarchives.com/tags/homelab/>Homelab</a></li>
<li><a href=https://adminarchives.com/tags/wireguard/>WireGuard</a></li>
<li><a href=https://adminarchives.com/tags/vps/>VPS</a></li>
<li><a href=https://adminarchives.com/tags/reverse-proxy/>Reverse Proxy</a></li>
<li><a href=https://adminarchives.com/tags/networking/>Networking</a></li>
</ul>
<nav class=paginav>
<a class=prev href=https://adminarchives.com/posts/isolate-homelab-with-vlan/>
<span class=title>« Prev</span>
<br>
<span>Isolate your homelab using VLANs, Proxmox, and OPNsense</span>
</a>
</nav>
</footer>
</article>
</main>
<footer class=footer>
<span>&copy; 2023 <a href=https://adminarchives.com/>Andrew's Admin Archives</a></span>
<span>
Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a>
</span>
</footer>
<a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a>
<script>let menu=document.getElementById('menu');menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script>
<script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script>
<script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script>
</body>
</html>