<!doctype html><html lang=en dir=auto>
<head><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=robots content="index, follow">
<title>Wireguard VPS as Reverse Proxy and Gateway to Home Network | Andrew Houser</title>
<meta name=keywords content="Homelab,Wireguard,VPS,Reverse Proxy">
<meta name=description content="Connect to home network and forward public services through VPS with Wireguard. Bypasses CGNAT and avoids directly exposing network.">
<meta name=author content="Andrew Houser">
<link rel=canonical href=https://andrew-houser.com/posts/vps-wireguard-gateway/>
<link crossorigin=anonymous href=/assets/css/stylesheet.5cfc680b1eeaeef9efbced92d46c2a9e876b72ee14fba85846afc4cff9e6e6f8.css integrity="sha256-XPxoCx7q7vnvvO2S1Gwqnodrcu4U+6hYRq/Ez/nm5vg=" rel="preload stylesheet" as=style>
<script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=http://andrewhouser.com/favicon.ico>
<link rel=icon type=image/png sizes=16x16 href=http://andrewhouser.com/favicon-16x16.png>
<link rel=icon type=image/png sizes=32x32 href=http://andrewhouser.com/favicon-32x32.png>
<link rel=apple-touch-icon href=http://andrewhouser.com/apple-touch-icon.png>
<link rel=mask-icon href=http://andrewhouser.com/safari-pinned-tab.svg>
<meta name=theme-color content="#2e2e33">
<meta name=msapplication-TileColor content="#2e2e33">
<noscript>
<style>#theme-toggle,.top-link{display:none}</style>
</noscript><meta property="og:title" content="Wireguard VPS as Reverse Proxy and Gateway to Home Network">
<meta property="og:description" content="Connect to home network and forward public services through VPS with Wireguard. Bypasses CGNAT and avoids directly exposing network.">
<meta property="og:type" content="article">
<meta property="og:url" content="http://andrewhouser.com/posts/vps-wireguard-gateway/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2023-08-23T12:20:06-04:00">
<meta property="article:modified_time" content="2023-08-23T12:20:06-04:00"><meta property="og:site_name" content="Andrew Houser">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="Wireguard VPS as Reverse Proxy and Gateway to Home Network">
<meta name=twitter:description content="Connect to home network and forward public services through VPS with Wireguard. Bypasses CGNAT and avoids directly exposing network.">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"http://andrewhouser.com/posts/"},{"@type":"ListItem","position":2,"name":"Wireguard VPS as Reverse Proxy and Gateway to Home Network","item":"http://andrewhouser.com/posts/vps-wireguard-gateway/"}]}</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Wireguard VPS as Reverse Proxy and Gateway to Home Network","name":"Wireguard VPS as Reverse Proxy and Gateway to Home Network","description":"Connect to home network and forward public services through VPS with Wireguard. Bypasses CGNAT and avoids directly exposing network.","keywords":["Homelab","Wireguard","VPS","Reverse Proxy"],"articleBody":"Network Diagram Requirments  Device or VM on home network with Wireguard VPS with public ip, Wireguard, and reverse proxy of choice.\n(Nginx Proxy Manager is great for most basic uses.)  Wireguard Configs  NOTE: The Wireguard network and your home network must be on different subnets! Custom routing and masquarading rules will allow you to connect to home network through Wireguard. These rules were adapted from adapted from Multi Hop Wireguard by Justin Ludwig.\n VPS Gateway [Interface] # Use unique WG subnet Address = 10.0.0.1/24  ListenPort = 51820 PrivateKey = #### # Route incoming WG traffic out of WG interface (Forward to home WG server) Table = 123 PreUp = sysctl -w net.ipv4.ip_forward=1 PreUp = ip rule add iif wg0 table 123 priority 456 PostDown = ip rule del iif wg0 table 123 priority 456 PreUp = sysctl -w net.ipv6.conf.all.forwarding=1 PreUp = ip -6 rule add iif wg0 table 123 priority 456 PostDown = ip -6 rule del iif wg0 table 123 priority 456 # Make this your home subnet. Custom route for traffic from VPS/reverse proxy PostUp = ip route add 192.168.1.1/24 dev wg0 # Home WG server. Use keep alive behind NAT. [Peer] PublicKey = #### PresharedKey = #### AllowedIPs = 0.0.0.0/0 PersistentKeepalive = 25 # Add other clients here Home Server [Interface] PrivateKey = #### Address = 10.0.0.2/24 # Masquerade traffic over default network (Home lan/wan) PreUp = sysctl -w net.ipv4.ip_forward=1 PreUp = iptables -t mangle -A PREROUTING -i wg0 -j MARK --set-mark 0x30 PreUp = iptables -t nat -A POSTROUTING ! -o wg0 -m mark --mark 0x30 -j MASQUERADE PostDown = iptables -t mangle -D PREROUTING -i wg0 -j MARK --set-mark 0x30 PostDown = iptables -t nat -D POSTROUTING ! -o wg0 -m mark --mark 0x30 -j MASQUERADE PreUp = sysctl -w net.ipv6.conf.all.forwarding=1 PreUp = ip6tables -t mangle -A PREROUTING -i wg0 -j MARK --set-mark 0x30 PreUp = ip6tables -t nat -A POSTROUTING ! -o wg0 -m mark --mark 0x30 -j MASQUERADE PostDown = ip6tables -t mangle -D PREROUTING -i wg0 -j MARK --set-mark 0x30 PostDown = ip6tables -t nat -D POSTROUTING ! -o wg0 -m mark --mark 0x30 -j MASQUERADE # Public VPS gateway [Peer] PublicKey = #### PresharedKey = #### Endpoint = ##.##.##.##:51820 AllowedIPs = 10.0.0.1/24 PersistentKeepalive = 25 ","wordCount":"374","inLanguage":"en","datePublished":"2023-08-23T12:20:06-04:00","dateModified":"2023-08-23T12:20:06-04:00","author":{"@type":"Person","name":"Andrew Houser"},"mainEntityOfPage":{"@type":"WebPage","@id":"http://andrewhouser.com/posts/vps-wireguard-gateway/"},"publisher":{"@type":"Organization","name":"Andrew Houser","logo":{"@type":"ImageObject","url":"http://andrewhouser.com/favicon.ico"}}}</script>
</head>
<body class=dark id=top>
<header class=header>
<nav class=nav>
<div class=logo>
<a href=http://andrewhouser.com/ accesskey=h title="Andrew Houser (Alt + H)">Andrew Houser</a>
<div class=logo-switches>
</div>
</div>
<ul id=menu>
<li>
<a href=http://andrewhouser.com/posts/ title=posts>
<span>posts</span>
</a>
</li>
<li>
<a href=http://andrewhouser.com/tags/ title=tags>
<span>tags</span>
</a>
</li>
<li>
<a href=http://andrewhouser.com/search/ title="search (Alt + /)" accesskey=/>
<span>search</span>
</a>
</li>
</ul>
</nav>
</header>
<main class=main>
<article class=post-single>
<header class=post-header>
<div class=breadcrumbs><a href=http://andrewhouser.com/>Home</a>&nbsp;»&nbsp;<a href=http://andrewhouser.com/posts/>Posts</a></div>
<h1 class=post-title>
Wireguard VPS as Reverse Proxy and Gateway to Home Network
</h1>
<div class=post-description>
Connect to home network and forward public services through VPS with Wireguard. Bypasses CGNAT and avoids directly exposing network.
</div>
<div class=post-meta><span title="2023-08-23 12:20:06 -0400 EDT">August 23, 2023</span>&nbsp;·&nbsp;2 min&nbsp;·&nbsp;374 words&nbsp;·&nbsp;Andrew Houser
</div>
</header> <div class=toc>
<details>
<summary accesskey=c title="(Alt + C)">
<span class=details>Table of Contents</span>
</summary>
<div class=inner><nav id=TableOfContents>
<ul>
<li><a href=#network-diagram>Network Diagram</a></li>
<li><a href=#requirments>Requirments</a></li>
<li><a href=#wireguard-configs>Wireguard Configs</a>
<ul>
<li><a href=#vps-gateway>VPS Gateway</a></li>
<li><a href=#home-server>Home Server</a></li>
</ul>
</li>
</ul>
</nav>
</div>
</details>
</div>
<div class=post-content><h2 id=network-diagram>Network Diagram<a hidden class=anchor aria-hidden=true href=#network-diagram>#</a></h2>
<p><img loading=lazy src=/vps-wg-diagram.png alt=diagram>
</p>
<h2 id=requirments>Requirments<a hidden class=anchor aria-hidden=true href=#requirments>#</a></h2>
<ul>
<li>Device or VM on home network with Wireguard</li>
<li>VPS with public ip, Wireguard, and reverse proxy of choice.<br>
(Nginx Proxy Manager is great for most basic uses.)</li>
</ul>
<h2 id=wireguard-configs>Wireguard Configs<a hidden class=anchor aria-hidden=true href=#wireguard-configs>#</a></h2>
<blockquote>
<p><strong>NOTE: The Wireguard network and your home network must be on different subnets!</strong> Custom routing and masquarading rules will allow you to connect to home network through Wireguard. These rules were adapted from adapted from <a href=https://www.procustodibus.com/blog/2022/06/multi-hop-wireguard/>Multi Hop Wireguard</a> by <a href=https://www.procustodibus.com/authors/justin-ludwig/>Justin Ludwig</a>.</p>
</blockquote>
<h3 id=vps-gateway>VPS Gateway<a hidden class=anchor aria-hidden=true href=#vps-gateway>#</a></h3>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>[<span style=color:#ae81ff>Interface]</span>
<span style=color:#75715e># Use unique WG subnet</span>
<span style=color:#ae81ff>Address = 10.0.0.1/24  </span>
<span style=color:#ae81ff>ListenPort = 51820</span>
<span style=color:#ae81ff>PrivateKey =</span> <span style=color:#75715e>####</span>


<span style=color:#75715e># Route incoming WG traffic out of WG interface (Forward to home WG server)</span>
<span style=color:#ae81ff>Table = 123</span>
<span style=color:#ae81ff>PreUp = sysctl -w net.ipv4.ip_forward=1</span>
<span style=color:#ae81ff>PreUp = ip rule add iif wg0 table 123 priority 456</span>
<span style=color:#ae81ff>PostDown = ip rule del iif wg0 table 123 priority 456</span>

<span style=color:#ae81ff>PreUp = sysctl -w net.ipv6.conf.all.forwarding=1</span>
<span style=color:#ae81ff>PreUp = ip -6 rule add iif wg0 table 123 priority 456</span>
<span style=color:#ae81ff>PostDown = ip -6 rule del iif wg0 table 123 priority 456</span>

<span style=color:#75715e># Make this your home subnet. Custom route for traffic from VPS/reverse proxy</span>

<span style=color:#ae81ff>PostUp = ip route add 192.168.1.1/24 dev wg0</span>

<span style=color:#75715e># Home WG server. Use keep alive behind NAT.</span>
[<span style=color:#ae81ff>Peer]</span>
<span style=color:#ae81ff>PublicKey =</span> <span style=color:#75715e>####</span>
<span style=color:#ae81ff>PresharedKey =</span> <span style=color:#75715e>####</span>
<span style=color:#ae81ff>AllowedIPs = 0.0.0.0/0</span>
<span style=color:#ae81ff>PersistentKeepalive = 25</span>

<span style=color:#75715e># Add other clients here</span>
</code></pre></div><h3 id=home-server>Home Server<a hidden class=anchor aria-hidden=true href=#home-server>#</a></h3>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>[<span style=color:#ae81ff>Interface]</span>
<span style=color:#ae81ff>PrivateKey =</span> <span style=color:#75715e>####</span>
<span style=color:#ae81ff>Address = 10.0.0.2/24</span>

<span style=color:#75715e># Masquerade traffic over default network (Home lan/wan)</span>
<span style=color:#ae81ff>PreUp = sysctl -w net.ipv4.ip_forward=1</span>
<span style=color:#ae81ff>PreUp = iptables -t mangle -A PREROUTING -i wg0 -j MARK --set-mark 0x30</span>
<span style=color:#ae81ff>PreUp = iptables -t nat -A POSTROUTING ! -o wg0 -m mark --mark 0x30 -j MASQUERADE</span>
<span style=color:#ae81ff>PostDown = iptables -t mangle -D PREROUTING -i wg0 -j MARK --set-mark 0x30</span>
<span style=color:#ae81ff>PostDown = iptables -t nat -D POSTROUTING ! -o wg0 -m mark --mark 0x30 -j MASQUERADE</span>

<span style=color:#ae81ff>PreUp = sysctl -w net.ipv6.conf.all.forwarding=1</span>
<span style=color:#ae81ff>PreUp = ip6tables -t mangle -A PREROUTING -i wg0 -j MARK --set-mark 0x30</span>
<span style=color:#ae81ff>PreUp = ip6tables -t nat -A POSTROUTING ! -o wg0 -m mark --mark 0x30 -j MASQUERADE</span>
<span style=color:#ae81ff>PostDown = ip6tables -t mangle -D PREROUTING -i wg0 -j MARK --set-mark 0x30</span>
<span style=color:#ae81ff>PostDown = ip6tables -t nat -D POSTROUTING ! -o wg0 -m mark --mark 0x30 -j MASQUERADE</span>

<span style=color:#75715e># Public VPS gateway</span>
[<span style=color:#ae81ff>Peer]</span>
<span style=color:#ae81ff>PublicKey =</span> <span style=color:#75715e>####</span>
<span style=color:#ae81ff>PresharedKey =</span> <span style=color:#75715e>####</span>
<span style=color:#ae81ff>Endpoint =</span> <span style=color:#75715e>##.##.##.##:51820</span>
<span style=color:#ae81ff>AllowedIPs = 10.0.0.1/24</span>
<span style=color:#ae81ff>PersistentKeepalive = 25</span>
</code></pre></div>
</div>
<footer class=post-footer>
<ul class=post-tags>
<li><a href=http://andrewhouser.com/tags/homelab/>Homelab</a></li>
<li><a href=http://andrewhouser.com/tags/wireguard/>Wireguard</a></li>
<li><a href=http://andrewhouser.com/tags/vps/>VPS</a></li>
<li><a href=http://andrewhouser.com/tags/reverse-proxy/>Reverse Proxy</a></li>
</ul>
</footer>
</article>
</main>
<footer class=footer>
<span>&copy; 2023 <a href=http://andrewhouser.com/>Andrew Houser</a></span>
<span>
Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a>
</span>
</footer>
<a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a>
<script>let menu=document.getElementById('menu');menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script>
<script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script>
</body>
</html>